<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Automation Pendo Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #f7f6f3;
            min-height: 100vh;
            padding: 40px 20px;
            color: #37352f;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 32px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .header h1 {
            font-size: 40px;
            font-weight: 700;
            color: #37352f;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: #37352f;
            color: white;
        }

        .btn-primary:hover {
            background: #2c2a26;
        }

        .btn-secondary {
            background: white;
            color: #37352f;
            border: 1px solid #e3e2df;
        }

        .btn-secondary:hover {
            background: #f7f6f3;
        }

        .blackout-info {
            background: white;
            border: 1px solid #e3e2df;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 24px;
        }

        .blackout-title {
            font-size: 14px;
            font-weight: 600;
            color: #37352f;
            margin-bottom: 12px;
        }

        .blackout-periods {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .period-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            background: #fef2f2;
            color: #991b1b;
        }

        .content {
            background: white;
            border: 1px solid #e3e2df;
            border-radius: 8px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        thead {
            background: #fafaf9;
            border-bottom: 1px solid #e3e2df;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #6b6b6b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            user-select: none;
        }

        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            cursor: col-resize;
            user-select: none;
            z-index: 1;
        }

        .resize-handle:hover {
            background: rgba(55, 53, 47, 0.1);
        }

        .resize-handle.active {
            background: rgba(55, 53, 47, 0.2);
        }

        /* Notion-style column colors */
        th:nth-child(1), td:nth-child(1) { background: #faf9f8; }  /* Area - warm beige */
        th:nth-child(2), td:nth-child(2) { background: #f7f9fa; }  /* Tracking - cool blue tint */
        th:nth-child(3), td:nth-child(3) { background: #faf8f9; }  /* Setup - light purple tint */
        th:nth-child(4), td:nth-child(4) { background: #faf8f9; }  /* Capture - light purple tint */
        th:nth-child(5), td:nth-child(5) { background: #f7f9fa; }  /* Target - cool blue tint */
        th:nth-child(6), td:nth-child(6) { background: #faf9f8; }  /* Blackout - warm beige */
        th:nth-child(7), td:nth-child(7) { background: #f8faf9; }  /* Status - light green tint */
        th:nth-child(8), td:nth-child(8) { background: #fef9f5; }  /* Task Type - warm orange tint */
        th:nth-child(9), td:nth-child(9) { background: #faf9f8; }  /* Notes - warm beige */

        tbody tr:hover td {
            filter: brightness(0.98);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f0f0ef;
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background: #fafaf9;
        }

        .metric-name {
            font-weight: 600;
            color: #37352f;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .metric-desc {
            font-size: 12px;
            color: #9b9a97;
        }

        .metric-cell {
            position: relative;
        }

        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: transparent;
            border: none;
            cursor: pointer;
            opacity: 0;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #9b9a97;
        }

        tr:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: #fee2e2;
            color: #991b1b;
        }

        textarea {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #e3e2df;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            color: #37352f;
            background: white;
            transition: all 0.15s ease;
        }

        textarea:hover {
            border-color: #d1d0cd;
        }

        textarea:focus {
            outline: none;
            border-color: #37352f;
            box-shadow: 0 0 0 2px rgba(55, 53, 47, 0.08);
        }

        /* Modern Notion-style date picker */
        input[type="date"] {
            width: 100%;
            padding: 6px 10px 6px 32px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            color: #37352f;
            background: transparent;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            appearance: none;
        }

        input[type="date"]:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        input[type="date"]:focus {
            outline: none;
            background: white;
            border-color: #37352f;
            box-shadow: 0 0 0 2px rgba(55, 53, 47, 0.08);
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            left: 8px;
            cursor: pointer;
            opacity: 0.4;
            transition: opacity 0.15s ease;
            width: 18px;
            height: 18px;
        }

        input[type="date"]:hover::-webkit-calendar-picker-indicator {
            opacity: 0.7;
        }

        input[type="date"]::-webkit-date-and-time-value {
            text-align: left;
        }

        textarea {
            resize: vertical;
            min-height: 70px;
            line-height: 1.5;
        }

        /* Status Select Styling */
        .status-select-wrapper {
            position: relative;
            width: 100%;
        }

        .status-select {
            appearance: none;
            width: 100%;
            padding: 4px 10px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            background-color: transparent;
        }

        .status-select:hover {
            filter: brightness(0.95);
        }

        .status-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(55, 53, 47, 0.15);
        }

        /* Status option colors */
        .status-select.status-not-started {
            background: #f3f3f2;
            color: #6b6b6b;
        }

        .status-select.status-planning {
            background: #e0f2fe;
            color: #075985;
        }

        .status-select.status-in-progress {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-select.status-complete {
            background: #d1fae5;
            color: #065f46;
        }

        .status-select.status-blocked {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Task Type Tags */
        .task-type-select {
            appearance: none;
            width: 100%;
            padding: 4px 10px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .task-type-select:hover {
            filter: brightness(0.95);
        }

        .task-type-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(55, 53, 47, 0.15);
        }

        .task-type-guide {
            background: #e0e7ff;
            color: #3730a3;
        }

        .task-type-tagging {
            background: #fae8ff;
            color: #86198f;
        }

        .task-type-tracking {
            background: #dbeafe;
            color: #075985;
        }

        .task-type-segment {
            background: #fff7ed;
            color: #9a3412;
        }

        .task-type-event {
            background: #fef3c7;
            color: #92400e;
        }

        .task-type-integration {
            background: #d1fae5;
            color: #065f46;
        }

        .task-type-not-applicable {
            background: #f3f3f2;
            color: #6b6b6b;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-not-started {
            background: #f3f3f2;
            color: #6b6b6b;
        }

        .status-planning {
            background: #e0f2fe;
            color: #075985;
        }

        .status-in-progress {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-complete {
            background: #d1fae5;
            color: #065f46;
        }

        .status-blocked {
            background: #fee2e2;
            color: #991b1b;
        }

        .blackout-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .blackout-yes {
            background: #fee2e2;
            color: #991b1b;
        }

        .blackout-no {
            background: #d1fae5;
            color: #065f46;
        }

        .warning {
            margin-top: 6px;
            padding: 6px 10px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            font-size: 12px;
            color: #991b1b;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .calendar-section {
            margin-top: 24px;
            background: white;
            border: 1px solid #e3e2df;
            border-radius: 8px;
            padding: 24px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #37352f;
        }

        .calendar-nav {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .calendar-nav-btn {
            background: white;
            border: 1px solid #e3e2df;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            color: #37352f;
        }

        .calendar-nav-btn:hover {
            background: #f7f6f3;
            border-color: #d1d0cd;
        }

        .calendar-month-label {
            font-size: 15px;
            font-weight: 600;
            color: #37352f;
            min-width: 150px;
            text-align: center;
        }

        .calendar-stats {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: #f7f6f3;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .calendar-stat {
            flex: 1;
            text-align: center;
        }

        .calendar-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #37352f;
        }

        .calendar-stat-label {
            font-size: 11px;
            color: #6b6b6b;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-stat.warning .calendar-stat-value {
            color: #dc2626;
        }

        .calendar-stat.success .calendar-stat-value {
            color: #16a34a;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e3e2df;
            border: 1px solid #e3e2df;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: #fafaf9;
            padding: 12px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #6b6b6b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 8px;
            position: relative;
            transition: all 0.15s ease;
        }

        .calendar-day:hover {
            background: #fafaf9;
        }

        .calendar-day.other-month {
            background: #f7f6f3;
            opacity: 0.5;
        }

        .calendar-day.today {
            background: #e0f2fe;
        }

        .calendar-day.blackout {
            background: #fee2e2;
        }

        .calendar-day-number {
            font-size: 12px;
            font-weight: 600;
            color: #37352f;
            margin-bottom: 6px;
        }

        .calendar-day.other-month .calendar-day-number {
            color: #9b9a97;
        }

        .calendar-day.today .calendar-day-number {
            color: #0369a1;
        }

        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .calendar-event {
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .calendar-event:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .calendar-event.setup {
            background: #dbeafe;
            color: #1e40af;
            border-left: 2px solid #3b82f6;
        }

        .calendar-event.golive {
            background: #dcfce7;
            color: #166534;
            border-left: 2px solid #22c55e;
            font-weight: 600;
        }

        .calendar-event.blackout-warning {
            background: #fee2e2;
            color: #991b1b;
            border-left: 2px solid #dc2626;
        }

        .calendar-legend {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e3e2df;
            font-size: 12px;
        }

        .calendar-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .calendar-legend-box {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .modal-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: #f7f6f3;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #6b6b6b;
            transition: all 0.15s ease;
        }

        .modal-close-btn:hover {
            background: #e3e2df;
            color: #37352f;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #37352f;
            padding-right: 40px;
        }

        .modal-body {
            font-size: 14px;
            line-height: 1.6;
            color: #6b6b6b;
        }

        .modal-footer {
            margin-top: 24px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .export-content {
            background: #f7f6f3;
            border: 1px solid #e3e2df;
            border-radius: 8px;
            padding: 16px;
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 16px;
            line-height: 1.6;
        }

        .copy-success {
            background: #d1fae5;
            color: #065f46;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f7f6f3;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d0cd;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9b9a97;
        }

        /* Undo Toast */
        .undo-toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #37352f;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 2000;
            transition: transform 0.3s ease;
            font-size: 14px;
        }

        .undo-toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .undo-toast-message {
            color: white;
        }

        .undo-btn {
            background: white;
            color: #37352f;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .undo-btn:hover {
            background: #f7f6f3;
        }

        /* Version History Styles */
        .version-item {
            background: #f7f6f3;
            border: 1px solid #e3e2df;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.15s ease;
        }

        .version-item:hover {
            background: #f0f0ef;
            border-color: #d1d0cd;
        }

        .version-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .version-timestamp {
            font-size: 14px;
            font-weight: 600;
            color: #37352f;
        }

        .version-info {
            font-size: 12px;
            color: #6b6b6b;
            margin-bottom: 12px;
        }

        .version-current {
            display: inline-block;
            padding: 4px 8px;
            background: #d1fae5;
            color: #065f46;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-restore {
            padding: 6px 12px;
            background: #37352f;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-restore:hover {
            background: #2c2a26;
        }

        .btn-restore:disabled {
            background: #d1d0cd;
            cursor: not-allowed;
        }

        .no-versions {
            text-align: center;
            padding: 40px 20px;
            color: #9b9a97;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>Tax Automation Pendo Planner</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="addNewMetric()">+ Add Metric</button>
                    <button class="btn btn-secondary" onclick="showVersionHistory()">‚è±Ô∏è History</button>
                    <button class="btn btn-secondary" onclick="resetData()">üîÑ Reset to Original</button>
                    <button class="btn btn-primary" onclick="exportData()">Export</button>
                </div>
            </div>

            <div class="blackout-info">
                <div class="blackout-title">üö´ US Pendo Guide Blackout Periods (No Publishing)</div>
                <div class="blackout-periods">
                    <span class="period-tag">Mar 10 - Mar 17, 2026</span>
                    <span class="period-tag">Apr 7 - Apr 15, 2026</span>
                    <span class="period-tag">Sep 8 - Sep 15, 2026</span>
                    <span class="period-tag">Oct 6 - Oct 15, 2026</span>
                </div>
            </div>
        </div>

        <div class="content">
            <table id="metricsTable">
                <colgroup>
                    <col style="width: 13%;">
                    <col style="width: 18%;">
                    <col style="width: 10%;">
                    <col style="width: 10%;">
                    <col style="width: 13%;">
                    <col style="width: 7%;">
                    <col style="width: 9%;">
                    <col style="width: 10%;">
                    <col style="width: 10%;">
                </colgroup>
                <thead>
                    <tr id="headerRow">
                        <th><span>Area / Metric</span><div class="resize-handle" data-col="0"></div></th>
                        <th><span>Tracking Need</span><div class="resize-handle" data-col="1"></div></th>
                        <th><span>Setup Window</span><div class="resize-handle" data-col="2"></div></th>
                        <th><span>Capture Start</span><div class="resize-handle" data-col="3"></div></th>
                        <th><span>Target / Measure</span><div class="resize-handle" data-col="4"></div></th>
                        <th><span>Blackout?</span><div class="resize-handle" data-col="5"></div></th>
                        <th><span>Status</span><div class="resize-handle" data-col="6"></div></th>
                        <th><span>Task Type</span><div class="resize-handle" data-col="7"></div></th>
                        <th><span>Notes</span></th>
                    </tr>
                </thead>
                <tbody id="metricsBody">
                </tbody>
            </table>
        </div>

        <div class="calendar-section">
            <div class="calendar-header">
                <h3>üìÖ Calendar View</h3>
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" onclick="changeMonth(-1)">‚Üê Prev</button>
                    <div class="calendar-month-label" id="calendarMonthLabel"></div>
                    <button class="calendar-nav-btn" onclick="changeMonth(1)">Next ‚Üí</button>
                    <button class="calendar-nav-btn" onclick="goToToday()">Today</button>
                </div>
            </div>
            <div id="calendarStats" class="calendar-stats"></div>
            <div id="calendarGrid" class="calendar-grid"></div>
            <div class="calendar-legend">
                <div class="calendar-legend-item">
                    <div class="calendar-legend-box" style="background: #e0f2fe;"></div>
                    <span>Today</span>
                </div>
                <div class="calendar-legend-item">
                    <div class="calendar-legend-box" style="background: #dbeafe; border-left: 2px solid #3b82f6;"></div>
                    <span>Setup</span>
                </div>
                <div class="calendar-legend-item">
                    <div class="calendar-legend-box" style="background: #dcfce7; border-left: 2px solid #22c55e;"></div>
                    <span>Go-Live</span>
                </div>
                <div class="calendar-legend-item">
                    <div class="calendar-legend-box" style="background: #fee2e2;"></div>
                    <span>Blackout Period</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="exportModal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal()" title="Close">‚úï</button>
            <div class="modal-header">Export Planning Data</div>
            <div class="modal-body">
                <p>Copy the data below to share or save your planning session:</p>
                <div class="export-content" id="exportContent"></div>
                <div id="copySuccess" class="copy-success" style="display: none;">
                    ‚úì Copied to clipboard!
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" onclick="copyToClipboard()">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <div class="modal" id="versionHistoryModal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeVersionHistoryModal()" title="Close">‚úï</button>
            <div class="modal-header">‚è±Ô∏è Version History</div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: #6b6b6b;">Restore your planner to a previous state. Snapshots are saved automatically.</p>
                <div id="versionHistoryList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeVersionHistoryModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="undo-toast" id="undoToast">
        <span class="undo-toast-message" id="undoMessage"></span>
        <button class="undo-btn" onclick="undoDelete()">Undo</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA-JaSxnG09AxTCSaaQS5NW9eQJcahj1Ww",
            authDomain: "pendo-planner.firebaseapp.com",
            databaseURL: "https://pendo-planner-default-rtdb.firebaseio.com",
            projectId: "pendo-planner",
            storageBucket: "pendo-planner.firebasestorage.app",
            messagingSenderId: "1016474416461",
            appId: "1:1016474416461:web:28bb4fd43912db0d2fb304",
            measurementId: "G-SG2K51ZNQL"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const metricsRef = database.ref('metrics');
        const columnsRef = database.ref('columnWidths');
        const versionsRef = database.ref('versions');
    </script>

    <script>
        const blackoutPeriods = [
            { start: new Date('2026-03-10'), end: new Date('2026-03-17'), name: 'Mar Blackout' },
            { start: new Date('2026-04-07'), end: new Date('2026-04-15'), name: 'Apr Blackout' },
            { start: new Date('2026-09-08'), end: new Date('2026-09-15'), name: 'Sep Blackout' },
            { start: new Date('2026-10-06'), end: new Date('2026-10-15'), name: 'Oct Blackout' }
        ];

        const initialData = [
            {
                id: 1,
                area: 'Gather ‚Äì Success Rate',
                areaShort: 'UltraTax Organizer Setup',
                tracking: 'SafeSend Support ticket reduction related to organizer setup tickets',
                setupWindow: '2025-11-18',
                captureStart: '',
                target: 'Target: 25% ticket reduction',
                status: 'Not Started',
                taskType: 'Tracking',
                notes: ''
            },
            {
                id: 2,
                area: 'Prep ‚Äì Success Rate',
                areaShort: '',
                tracking: 'Pendo Binder status events; Download Files completion; cross-tab journey map',
                setupWindow: '2026-01-12',
                captureStart: '2026-01-19',
                target: 'Target: 75% reach Download Files (vs. 62% beta)',
                status: 'Not Started',
                taskType: 'Tagging',
                notes: ''
            },
            {
                id: 3,
                area: 'Prep ‚Äì Time Savings',
                areaShort: 'Wave 1',
                tracking: 'Guide trigger on first Download documents click; capture hours saved/return',
                setupWindow: '2026-02-23',
                captureStart: '2026-03-02',
                target: 'Target: 1.45 hrs avg saved per 1040',
                status: 'Not Started',
                taskType: 'Guide',
                notes: 'Fits "end of Feb ‚Üí mid-March"'
            },
            {
                id: 4,
                area: 'Prep ‚Äì Time Savings',
                areaShort: 'Wave 2',
                tracking: 'Second guide for post-deadline cohort',
                setupWindow: '2026-04-15',
                captureStart: '2026-04-22',
                target: 'Compare wave-2 vs. wave-1',
                status: 'Not Started',
                taskType: 'Guide',
                notes: ''
            },
            {
                id: 5,
                area: 'Prep ‚Äì Integration Adoption',
                areaShort: 'SurePrep',
                tracking: 'Custom event or data import for successful firm-ID lookup API responses',
                setupWindow: '2025-11-11',
                captureStart: '2025-11-18',
                target: 'Target: 50% of eligible users',
                status: 'Not Started',
                taskType: 'Integration',
                notes: ''
            },
            {
                id: 6,
                area: 'Deliver ‚Äì Automation Adoption',
                areaShort: 'SafeSend',
                tracking: 'Activation event from SafeSend ‚Üí Pendo; segment eligible firms',
                setupWindow: '',
                captureStart: '',
                target: 'Target: 50% of eligible firms',
                status: 'Not Started',
                taskType: 'Segment',
                notes: ''
            },
            {
                id: 7,
                area: 'User Satisfaction ‚Äì pNPS',
                areaShort: 'Initial capabilities',
                tracking: 'pNPS moments at: first successful prep, SurePrep link success, e-file automation completion',
                setupWindow: '2026-02-17',
                captureStart: '2026-02-24',
                target: 'Target: 3.80‚Äì4.40 start range',
                status: 'Not Started',
                taskType: 'Guide',
                notes: ''
            },
            {
                id: 8,
                area: 'User Satisfaction ‚Äì pNPS',
                areaShort: 'Initial capabilities - Alt 2',
                tracking: 'pNPS moments at: first successful prep, SurePrep link success, e-file automation completion',
                setupWindow: '2026-04-07',
                captureStart: '2026-04-15',
                target: 'Target: 3.80‚Äì4.40 start range',
                status: 'Not Started',
                taskType: 'Guide',
                notes: ''
            }
        ];

        let metricsData = [];
        let deletedMetric = null;
        let undoTimeout = null;
        let isLoadingFromFirebase = false;
        let saveDebounceTimeout = null;
        let lastSnapshotTime = 0;
        const SNAPSHOT_INTERVAL = 5 * 60 * 1000; // 5 minutes between auto-snapshots

        // Load data from Firebase with real-time sync
        function loadData() {
            isLoadingFromFirebase = true;

            metricsRef.once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && Array.isArray(data)) {
                    metricsData = data;
                } else {
                    // Initialize with default data if nothing exists
                    metricsData = JSON.parse(JSON.stringify(initialData));
                    saveData();
                }
                renderTable();
                isLoadingFromFirebase = false;
            });

            // Set up real-time listener for changes
            metricsRef.on('value', (snapshot) => {
                if (isLoadingFromFirebase) return; // Skip first load

                const data = snapshot.val();
                if (data && Array.isArray(data)) {
                    metricsData = data;
                    renderTable();
                }
            });
        }

        // Save data to Firebase (syncs to all users)
        function saveData() {
            metricsRef.set(metricsData).catch(error => {
                console.error('Error saving to Firebase:', error);
                alert('Failed to save data. Please check your connection.');
            });

            // Auto-create snapshots every 5 minutes
            const now = Date.now();
            if (now - lastSnapshotTime > SNAPSHOT_INTERVAL) {
                createSnapshot('Auto-save');
                lastSnapshotTime = now;
            }
        }

        // Debounced save for textarea inputs (prevents too many saves while typing)
        function debouncedSaveData() {
            if (saveDebounceTimeout) {
                clearTimeout(saveDebounceTimeout);
            }
            saveDebounceTimeout = setTimeout(() => {
                saveData();
            }, 500); // Save 500ms after user stops typing
        }

        // Create a snapshot of current data
        function createSnapshot(label = 'Manual save') {
            const snapshot = {
                timestamp: Date.now(),
                label: label,
                data: JSON.parse(JSON.stringify(metricsData)), // Deep copy
                metricsCount: metricsData.length
            };

            versionsRef.push(snapshot).catch(error => {
                console.error('Error saving snapshot:', error);
            });

            // Keep only last 50 versions to avoid storage bloat
            versionsRef.once('value', (snapshot) => {
                const versions = snapshot.val();
                if (versions) {
                    const versionKeys = Object.keys(versions);
                    if (versionKeys.length > 50) {
                        // Sort by timestamp and remove oldest
                        const sortedKeys = versionKeys.sort((a, b) =>
                            versions[a].timestamp - versions[b].timestamp
                        );
                        const toDelete = sortedKeys.slice(0, versionKeys.length - 50);
                        toDelete.forEach(key => {
                            versionsRef.child(key).remove();
                        });
                    }
                }
            });
        }

        function parseDate(dateStr) {
            if (!dateStr || dateStr === 'TBD' || dateStr === 'Ongoing' || dateStr === '') return null;

            const weekOfMatch = dateStr.match(/Week of (\w+ \d+, \d{4})/i);
            if (weekOfMatch) {
                return new Date(weekOfMatch[1]);
            }

            const rangeMatch = dateStr.match(/(\w+ \d+)[‚Äì-](\d+), (\d{4})/);
            if (rangeMatch) {
                return new Date(`${rangeMatch[1]}, ${rangeMatch[3]}`);
            }

            // For YYYY-MM-DD format from date input, parse it correctly without timezone issues
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                const [year, month, day] = dateStr.split('-').map(Number);
                return new Date(year, month - 1, day);
            }

            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        }

        function formatDateForInput(dateStr) {
            if (!dateStr || dateStr === 'TBD' || dateStr === 'Ongoing' || dateStr === '') return '';

            // If already in YYYY-MM-DD format, return as is
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }

            const date = parseDate(dateStr);
            if (!date) return '';

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function checkBlackoutConflict(dateStr) {
            const date = parseDate(dateStr);
            if (!date) return null;

            for (let period of blackoutPeriods) {
                if (date >= period.start && date <= period.end) {
                    return { period: period.name };
                }
            }

            return null;
        }

        let currentCalendarDate = new Date();

        function renderCalendar() {
            const statsDiv = document.getElementById('calendarStats');
            const gridDiv = document.getElementById('calendarGrid');
            const labelDiv = document.getElementById('calendarMonthLabel');

            // Calculate stats
            const total = metricsData.length;
            const withDates = metricsData.filter(m => m.captureStart).length;
            const inBlackout = metricsData.filter(m => checkBlackoutConflict(m.captureStart)).length;

            const thisMonth = metricsData.filter(m => {
                const date = parseDate(m.captureStart);
                if (!date) return false;
                return date.getMonth() === currentCalendarDate.getMonth() &&
                       date.getFullYear() === currentCalendarDate.getFullYear();
            }).length;

            // Render stats
            statsDiv.innerHTML = `
                <div class="calendar-stat">
                    <div class="calendar-stat-value">${total}</div>
                    <div class="calendar-stat-label">Total Metrics</div>
                </div>
                <div class="calendar-stat">
                    <div class="calendar-stat-value">${withDates}</div>
                    <div class="calendar-stat-label">Scheduled</div>
                </div>
                <div class="calendar-stat ${inBlackout > 0 ? 'warning' : ''}">
                    <div class="calendar-stat-value">${inBlackout}</div>
                    <div class="calendar-stat-label">In Blackout</div>
                </div>
                <div class="calendar-stat ${thisMonth > 0 ? 'success' : ''}">
                    <div class="calendar-stat-value">${thisMonth}</div>
                    <div class="calendar-stat-label">This Month</div>
                </div>
            `;

            // Set month label
            labelDiv.textContent = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Build calendar
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            let html = '';

            // Day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            // Previous month days
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }

            // Current month days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                const isToday = currentDate.toDateString() === today.toDateString();
                const isBlackout = blackoutPeriods.some(period =>
                    currentDate >= period.start && currentDate <= period.end
                );

                // Find events for this day
                const events = [];
                metricsData.forEach(metric => {
                    const setupDate = parseDate(metric.setupWindow);
                    const captureDate = parseDate(metric.captureStart);

                    if (setupDate && setupDate.toDateString() === currentDate.toDateString()) {
                        events.push({
                            type: 'setup',
                            text: `Setup: ${metric.area}`,
                            metric: metric
                        });
                    }

                    if (captureDate && captureDate.toDateString() === currentDate.toDateString()) {
                        const hasConflict = checkBlackoutConflict(metric.captureStart);
                        events.push({
                            type: hasConflict ? 'blackout-warning' : 'golive',
                            text: `üöÄ ${metric.area}`,
                            metric: metric
                        });
                    }
                });

                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (isBlackout) classes += ' blackout';

                html += `<div class="${classes}">`;
                html += `<div class="calendar-day-number">${day}</div>`;

                if (events.length > 0) {
                    html += '<div class="calendar-events">';
                    events.forEach(event => {
                        html += `<div class="calendar-event ${event.type}" title="${event.text}">${event.text}</div>`;
                    });
                    html += '</div>';
                }

                html += '</div>';
            }

            // Next month days
            const remainingDays = 42 - (startingDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }

            gridDiv.innerHTML = html;
        }

        function changeMonth(delta) {
            currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + delta, 1);
            renderCalendar();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
        }

        function renderTable() {
            const tbody = document.getElementById('metricsBody');
            tbody.innerHTML = '';

            metricsData.forEach(metric => {
                const row = document.createElement('tr');

                const captureConflict = checkBlackoutConflict(metric.captureStart);
                const inBlackout = captureConflict; // Only capture start matters for blackout

                const statusClass = `status-${metric.status.toLowerCase().replace(' ', '-')}`;

                row.innerHTML = `
                    <td class="metric-cell">
                        <button class="delete-btn" onclick="deleteMetric(${metric.id})" title="Delete metric">√ó</button>
                        <div class="metric-name">${metric.area}</div>
                        ${metric.areaShort ? `<div class="metric-desc">${metric.areaShort}</div>` : ''}
                    </td>
                    <td>
                        <textarea oninput="updateMetric(${metric.id}, 'tracking', this.value, true)" onblur="updateMetric(${metric.id}, 'tracking', this.value, false)">${metric.tracking}</textarea>
                    </td>
                    <td>
                        <input type="date" value="${formatDateForInput(metric.setupWindow)}"
                               onchange="updateMetric(${metric.id}, 'setupWindow', this.value)">
                    </td>
                    <td>
                        <input type="date" value="${formatDateForInput(metric.captureStart)}"
                               onchange="updateMetric(${metric.id}, 'captureStart', this.value)">
                        ${captureConflict ? `
                            <div class="warning">
                                <span>üö´</span>
                                <span>${captureConflict.period}</span>
                            </div>
                        ` : ''}
                    </td>
                    <td>
                        <textarea oninput="updateMetric(${metric.id}, 'target', this.value, true)" onblur="updateMetric(${metric.id}, 'target', this.value, false)">${metric.target}</textarea>
                    </td>
                    <td>
                        <span class="blackout-badge ${inBlackout ? 'blackout-yes' : 'blackout-no'}">
                            ${inBlackout ? 'Yes' : 'No'}
                        </span>
                    </td>
                    <td>
                        <select class="status-select ${statusClass}" onchange="updateMetric(${metric.id}, 'status', this.value)">
                            <option value="Not Started" ${metric.status === 'Not Started' ? 'selected' : ''}>‚ö™ Not Started</option>
                            <option value="Planning" ${metric.status === 'Planning' ? 'selected' : ''}>üîµ Planning</option>
                            <option value="In Progress" ${metric.status === 'In Progress' ? 'selected' : ''}>üîµ In Progress</option>
                            <option value="Complete" ${metric.status === 'Complete' ? 'selected' : ''}>‚úÖ Complete</option>
                            <option value="Blocked" ${metric.status === 'Blocked' ? 'selected' : ''}>üö´ Blocked</option>
                        </select>
                    </td>
                    <td>
                        <select class="task-type-select task-type-${(metric.taskType || 'Not Applicable').toLowerCase().replace(' ', '-')}" onchange="updateMetric(${metric.id}, 'taskType', this.value)">
                            <option value="Guide" ${(metric.taskType || '') === 'Guide' ? 'selected' : ''}>üìñ Guide</option>
                            <option value="Tagging" ${(metric.taskType || '') === 'Tagging' ? 'selected' : ''}>üè∑Ô∏è Tagging</option>
                            <option value="Tracking" ${(metric.taskType || '') === 'Tracking' ? 'selected' : ''}>üìä Tracking</option>
                            <option value="Segment" ${(metric.taskType || '') === 'Segment' ? 'selected' : ''}>üë• Segment</option>
                            <option value="Event" ${(metric.taskType || '') === 'Event' ? 'selected' : ''}>‚ö° Event</option>
                            <option value="Integration" ${(metric.taskType || '') === 'Integration' ? 'selected' : ''}>üîó Integration</option>
                            <option value="Not Applicable" ${(metric.taskType || 'Not Applicable') === 'Not Applicable' ? 'selected' : ''}>‚Äî Not Applicable</option>
                        </select>
                    </td>
                    <td>
                        <textarea oninput="updateMetric(${metric.id}, 'notes', this.value, true)" onblur="updateMetric(${metric.id}, 'notes', this.value, false)">${metric.notes}</textarea>
                    </td>
                `;

                tbody.appendChild(row);
            });

            // Update calendar whenever table is rendered
            renderCalendar();
        }

        function updateMetric(id, field, value, isTyping = false) {
            const metric = metricsData.find(m => m.id === id);
            if (metric) {
                metric[field] = value;

                // Use debounced save for text inputs while typing
                if (isTyping) {
                    debouncedSaveData();
                } else {
                    // Immediate save for blur events and non-text inputs
                    saveData();
                }

                // Only re-render for fields that affect the UI display
                if (field === 'setupWindow' || field === 'captureStart' || field === 'status' || field === 'taskType') {
                    // Save textarea heights before re-rendering
                    saveTextareaHeights();
                    renderTable();
                    // Restore textarea heights after re-rendering
                    restoreTextareaHeights();
                }
            }
        }

        function saveTextareaHeights() {
            const textareas = document.querySelectorAll('textarea');
            const heights = {};
            textareas.forEach((textarea, index) => {
                if (textarea.style.height) {
                    // Get the metric ID and field from the oninput or onchange attribute
                    const oninput = textarea.getAttribute('oninput');
                    const onchange = textarea.getAttribute('onchange');
                    const attrValue = oninput || onchange;
                    if (attrValue) {
                        const match = attrValue.match(/updateMetric\((\d+),\s*'(\w+)'/);
                        if (match) {
                            const key = `${match[1]}_${match[2]}`;
                            heights[key] = textarea.style.height;
                        }
                    }
                }
            });
            sessionStorage.setItem('textareaHeights', JSON.stringify(heights));
        }

        function restoreTextareaHeights() {
            const saved = sessionStorage.getItem('textareaHeights');
            if (saved) {
                const heights = JSON.parse(saved);
                const textareas = document.querySelectorAll('textarea');
                textareas.forEach(textarea => {
                    const oninput = textarea.getAttribute('oninput');
                    const onchange = textarea.getAttribute('onchange');
                    const attrValue = oninput || onchange;
                    if (attrValue) {
                        const match = attrValue.match(/updateMetric\((\d+),\s*'(\w+)'/);
                        if (match) {
                            const key = `${match[1]}_${match[2]}`;
                            if (heights[key]) {
                                textarea.style.height = heights[key];
                            }
                        }
                    }
                });
            }
        }

        function addNewMetric() {
            const newId = Math.max(...metricsData.map(m => m.id), 0) + 1;
            const newMetric = {
                id: newId,
                area: 'New Metric',
                areaShort: '',
                tracking: '',
                setupWindow: '',
                captureStart: '',
                target: '',
                status: 'Not Started',
                taskType: 'Not Applicable',
                notes: ''
            };

            metricsData.push(newMetric);
            saveData();
            renderTable();
        }

        function deleteMetric(id) {
            const metric = metricsData.find(m => m.id === id);
            if (metric) {
                // Store deleted metric and its position
                const index = metricsData.findIndex(m => m.id === id);
                deletedMetric = { metric: {...metric}, index: index };

                // Remove from array
                metricsData = metricsData.filter(m => m.id !== id);
                saveData();
                renderTable();

                // Show undo toast
                showUndoToast(metric.area);
            }
        }

        function showUndoToast(metricName) {
            const toast = document.getElementById('undoToast');
            const message = document.getElementById('undoMessage');

            message.textContent = `Deleted "${metricName}"`;
            toast.classList.add('show');

            // Clear previous timeout
            if (undoTimeout) {
                clearTimeout(undoTimeout);
            }

            // Auto-hide after 5 seconds
            undoTimeout = setTimeout(() => {
                hideUndoToast();
                deletedMetric = null; // Clear the deleted metric after timeout
            }, 5000);
        }

        function hideUndoToast() {
            const toast = document.getElementById('undoToast');
            toast.classList.remove('show');
        }

        function undoDelete() {
            if (deletedMetric) {
                // Restore the metric at its original position
                metricsData.splice(deletedMetric.index, 0, deletedMetric.metric);
                saveData();
                renderTable();

                // Hide toast
                hideUndoToast();
                deletedMetric = null;

                if (undoTimeout) {
                    clearTimeout(undoTimeout);
                }
            }
        }

        function exportData() {
            let output = 'TAX AUTOMATION PENDO PLANNER - PLANNING SESSION\n';
            output += '='.repeat(80) + '\n\n';

            output += 'US PENDO GUIDE BLACKOUT PERIODS (NO PUBLISHING):\n';
            output += '  üö´ Mar 10 - Mar 17, 2026\n';
            output += '  üö´ Apr 7 - Apr 15, 2026\n';
            output += '  üö´ Sep 8 - Sep 15, 2026\n';
            output += '  üö´ Oct 6 - Oct 15, 2026\n\n';
            output += '='.repeat(80) + '\n\n';

            metricsData.forEach((metric, index) => {
                output += `${index + 1}. ${metric.area}${metric.areaShort ? ` (${metric.areaShort})` : ''}\n`;
                output += `   Status: ${metric.status}\n`;
                output += `   Tracking: ${metric.tracking}\n`;
                output += `   Setup Window: ${metric.setupWindow}\n`;
                output += `   Capture Start (Go-Live): ${metric.captureStart}\n`;

                const captureConflict = checkBlackoutConflict(metric.captureStart);
                if (captureConflict) {
                    output += `      üö´ BLACKOUT CONFLICT: ${captureConflict.period}\n`;
                }

                output += `   Target/Measure: ${metric.target}\n`;
                output += `   In Blackout Period: ${captureConflict ? 'YES' : 'NO'}\n`;
                output += `   Task Type: ${metric.taskType || 'Not Applicable'}\n`;
                if (metric.notes) {
                    output += `   Notes: ${metric.notes}\n`;
                }
                output += '\n' + '-'.repeat(80) + '\n\n';
            });

            const generalNotes = document.getElementById('generalNotes').value;
            if (generalNotes) {
                output += 'GENERAL PLANNING NOTES:\n';
                output += generalNotes + '\n\n';
            }

            output += '='.repeat(80) + '\n';
            output += `Exported: ${new Date().toLocaleString()}\n`;

            document.getElementById('exportContent').textContent = output;
            document.getElementById('exportModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('exportModal').classList.remove('active');
            document.getElementById('copySuccess').style.display = 'none';
        }

        function closeModalOnBackdrop(event) {
            if (event.target.id === 'exportModal') {
                closeModal();
            }
        }

        function copyToClipboard() {
            const content = document.getElementById('exportContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                document.getElementById('copySuccess').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('copySuccess').style.display = 'none';
                }, 2000);
            });
        }

        function resetData() {
            if (confirm('Are you sure you want to reset all data to the original 8 metrics? Your current state will be saved as a snapshot first.')) {
                // Save current state before resetting
                createSnapshot('Before reset');

                // Reset to initial data
                metricsData = JSON.parse(JSON.stringify(initialData));
                saveData();
                renderTable();

                alert('Data has been reset to original state. You can restore your previous version from History if needed.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initColumnResize();
        });

        // Column resizing functionality
        function initColumnResize() {
            const table = document.getElementById('metricsTable');
            const cols = table.querySelectorAll('col');
            const handles = document.querySelectorAll('.resize-handle');

            let currentHandle = null;
            let currentCol = null;
            let startX = 0;
            let startWidth = 0;
            let tableWidth = 0;

            handles.forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    currentHandle = handle;
                    const colIndex = parseInt(handle.getAttribute('data-col'));
                    currentCol = cols[colIndex];
                    startX = e.pageX;

                    // Get current width
                    tableWidth = table.offsetWidth;
                    startWidth = currentCol.offsetWidth;

                    handle.classList.add('active');
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                });
            });

            document.addEventListener('mousemove', (e) => {
                if (!currentHandle || !currentCol) return;

                e.preventDefault();
                const diff = e.pageX - startX;
                const newWidth = startWidth + diff;
                const minWidth = 50; // Minimum column width

                if (newWidth >= minWidth) {
                    const percentage = (newWidth / tableWidth) * 100;
                    currentCol.style.width = percentage + '%';
                }
            });

            document.addEventListener('mouseup', () => {
                if (currentHandle) {
                    currentHandle.classList.remove('active');
                    currentHandle = null;
                    currentCol = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';

                    // Save column widths
                    saveColumnWidths();
                }
            });
        }

        function saveColumnWidths() {
            const table = document.getElementById('metricsTable');
            const cols = table.querySelectorAll('col');
            const widths = Array.from(cols).map(col => col.style.width);
            columnsRef.set(widths).catch(error => {
                console.error('Error saving column widths:', error);
            });
        }

        function loadColumnWidths() {
            columnsRef.once('value', (snapshot) => {
                const widths = snapshot.val();
                if (widths && Array.isArray(widths)) {
                    const table = document.getElementById('metricsTable');
                    const cols = table.querySelectorAll('col');
                    widths.forEach((width, index) => {
                        if (cols[index] && width) {
                            cols[index].style.width = width;
                        }
                    });
                }
            });
        }

        // Show version history modal
        function showVersionHistory() {
            const modal = document.getElementById('versionHistoryModal');
            const listDiv = document.getElementById('versionHistoryList');

            listDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #9b9a97;">Loading versions...</div>';
            modal.classList.add('active');

            versionsRef.orderByChild('timestamp').once('value', (snapshot) => {
                const versions = snapshot.val();

                if (!versions || Object.keys(versions).length === 0) {
                    listDiv.innerHTML = '<div class="no-versions">No saved versions yet. Versions are saved automatically every 5 minutes.</div>';
                    return;
                }

                // Convert to array and sort by timestamp (newest first)
                const versionArray = Object.keys(versions).map(key => ({
                    id: key,
                    ...versions[key]
                })).sort((a, b) => b.timestamp - a.timestamp);

                let html = '';
                versionArray.forEach((version, index) => {
                    const date = new Date(version.timestamp);
                    const timeAgo = getTimeAgo(version.timestamp);
                    const isCurrent = index === 0;

                    html += `
                        <div class="version-item">
                            <div class="version-item-header">
                                <div>
                                    <div class="version-timestamp">
                                        ${date.toLocaleString('en-US', {
                                            month: 'short',
                                            day: 'numeric',
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                        ${isCurrent ? '<span class="version-current">Current</span>' : ''}
                                    </div>
                                    <div class="version-info">
                                        ${timeAgo} ‚Ä¢ ${version.metricsCount} metrics ‚Ä¢ ${version.label}
                                    </div>
                                </div>
                                <button class="btn-restore"
                                        onclick="restoreVersion('${version.id}')"
                                        ${isCurrent ? 'disabled' : ''}>
                                    ${isCurrent ? 'Current' : 'Restore'}
                                </button>
                            </div>
                        </div>
                    `;
                });

                listDiv.innerHTML = html;
            });
        }

        // Get human-readable time ago
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 2592000) return Math.floor(seconds / 86400) + ' days ago';
            return Math.floor(seconds / 2592000) + ' months ago';
        }

        // Restore a specific version
        function restoreVersion(versionId) {
            if (!confirm('Are you sure you want to restore this version? Your current state will be saved as a snapshot before restoring.')) {
                return;
            }

            // Save current state before restoring
            createSnapshot('Before restore');

            // Get the version data
            versionsRef.child(versionId).once('value', (snapshot) => {
                const version = snapshot.val();
                if (version && version.data) {
                    metricsData = JSON.parse(JSON.stringify(version.data)); // Deep copy
                    saveData();
                    renderTable();
                    closeVersionHistoryModal();

                    // Show success message
                    alert('Version restored successfully!');
                }
            });
        }

        // Close version history modal
        function closeVersionHistoryModal() {
            document.getElementById('versionHistoryModal').classList.remove('active');
        }

        // Update closeModal to handle both modals
        function closeModal() {
            document.getElementById('exportModal').classList.remove('active');
            document.getElementById('copySuccess').style.display = 'none';
        }

        // Update keyboard handler to close any open modal
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const exportModal = document.getElementById('exportModal');
                const versionModal = document.getElementById('versionHistoryModal');
                if (exportModal.classList.contains('active')) {
                    closeModal();
                }
                if (versionModal.classList.contains('active')) {
                    closeVersionHistoryModal();
                }
            }
        });

        loadData();
        loadColumnWidths();
        renderTable();
    </script>
</body>
</html>